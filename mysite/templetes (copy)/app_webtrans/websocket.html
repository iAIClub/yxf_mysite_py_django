<div id="websocket">
    {% if request.user.is_superuser %}
    <div class="row" style="margin-right:0;">
        <div class="col-xs-9 col-sm-9 col-md-9">
            <h4>通过Websocket与后台的图灵机器人实时对话</h4>
            <textarea style="width:100%;height:450px;background-color:honeydew;" readonly="readonly"></textarea>
            <div>
                <input type="text" id="message" style="width:75%;">
                <button class="btn btn-info" id="send">发送</button>
                <br>
            </div>
        </div>
        <div class="col-xs-3 col-sm-3 col-md-3">
            <br>
            <div class="panel">
                <div class="panel-heading" style="color:darkgreen">
                    <span class="glyphicon glyphicon-flag"></span>
                    TCP服务器
                </div>
                <div class="list-group" id="server" style="font-size:0.8rem;">
                    <a class="list-group-item" id="tcpserver" href="javascript:;">TcpSrver</a>
                </div>
            </div>
            <div class="panel">
                <div class="panel-heading" style="color:darkgreen">
                    <span class="glyphicon glyphicon-flag"></span>
                    TCP通信在线用户
                </div>
                <div class="list-group" id="onlineuser" style="font-size:0.8rem;">
                    <a class="list-group-item" href="javascript:;">1</a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <h4>请先登录！</h4>
    {% endif %}
</div>
<script type="text/javascript">
$(function(){
    //heartbeat
    function keepalive(ws) {
        var time = new Date();
        if ((time.getTime() - last_health > 35000)) {
            //ws.close();
            //clearInterval(window.heartbeat_timer)
        } else {
            if (ws.bufferedAmount == 0 && ws.readyState == 1) {
                ws.send('ping')
            }
        }
    }

    //connect
    if (socket) {
        socket.close()
    }
    var socket = new WebSocket("ws://" + window.location.hostname + ':8007');
    socket.onopen = function () {
        console.log("websocket connect");
        //socket.send('hello');
        //window.heartbeat_timer = setInterval(function () {keepalive(socket)}, 30000);
    };
    socket.onclose = function () {
        console.log("websocket close");
    };
    socket.onerror = function () {
        console.log("websocket error");
    };

    //message
    socket.onmessage = function (e) {
        $('#websocket textarea').append("[server]"+e.data+'\n');
    };
    $("#send").click(function(){
        $('#websocket textarea').append("<p style=''>"+$('#message').val()+"</p>");
        socket.send($('#message').val());
        $('#message').val("");
    });
});
</script>